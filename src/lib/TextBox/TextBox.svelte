<script lang="ts">
	import { createEventDispatcher } from "svelte";

	import TextBoxButton from "./TextBoxButton.svelte";

	/** Specifies the input's native value attribute */
	export let value: any = "";

    /** Determines the input type of the textbox */
	export let type = "text";

	/** Determines whether a text clear button is present */
	export let placeholder: string = undefined;

	/** Determines whether a text clear button is present */
	export let clearButton = true;

	/** Determines whether a search button is present when `type` is set to "search" */
	export let searchButton = true;

	/** Determines whether a password reveal button is present when `type` is set to "password" */
	export let revealButton = true;

	/** Controls whether the textbox is disabled */
	export let disabled = false;

	/** Specifies a custom class name for the textbox */
	let className = "";
	export { className as class };

	let input;

	function handleClear(event) {
		dispatch("clear", event);
		input.focus();
		value = "";
	}

	function handleSearch(event) {
		dispatch("search", event);
		input.focus;
	}

	function handleReveal(event) {
		input.focus();
		input.setAttribute("type", "text");
		dispatch("reveal", event);
		let revealButtonMouseDown = true;
		const hidePassword = () => {
			if (!revealButtonMouseDown) return;
			input.focus();
			revealButtonMouseDown = false;
			input.setAttribute("type", "password");
			window.removeEventListener("mouseup", hidePassword);
		};
		window.addEventListener("mouseup", hidePassword);
	}

	const dispatch = createEventDispatcher();
</script>

<div class="text-box-container" class:disabled>
	<input
		class="text-box {className ?? ''}"
		{value}
		{type}
		{disabled}
		{placeholder}
		{...$$restProps}
		bind:this={input}
		on:change
		on:input={() => (value = input.value)}
		on:input
		on:beforeinput
		on:click
		on:blur
		on:focus
		on:dblclick
		on:contextmenu
		on:mousedown
		on:mouseup
		on:mouseover
		on:mouseout
		on:mouseleave
		on:keypress
		on:keydown
		on:keyup
	/>
	<div class="text-box-underline" />
	<div class="text-box-buttons">
		{#if clearButton && value}
			<TextBoxButton
				aria-label="Clear text"
				on:click={handleClear}
				class="text-box-clear-button"
			>
				<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="171 171 683 683">
					<path
						d="M512,572.5L243.5,841C235.167,849.333 225.167,853.5 213.5,853.5C201.5,853.5 191.333,849.333 183,841C174.667,832.667 170.5,822.5 170.5,810.5C170.5,798.833 174.667,788.833 183,780.5L451.5,512L183,243.5C174.667,235.167 170.5,225 170.5,213C170.5,207 171.667,201.417 174,196.25C176.333,191.083 179.417,186.583 183.25,182.75C187.083,178.917 191.583,175.917 196.75,173.75C201.917,171.583 207.5,170.5 213.5,170.5C225.167,170.5 235.167,174.667 243.5,183L512,451.5L780.5,183C788.833,174.667 798.833,170.5 810.5,170.5C822.5,170.5 832.667,174.667 841,183C849.333,191.333 853.5,201.5 853.5,213.5C853.5,225.167 849.333,235.167 841,243.5L572.5,512L841,780.5C849.333,788.833 853.5,799 853.5,811C853.5,817 852.333,822.583 850,827.75C847.667,832.917 844.583,837.417 840.75,841.25C836.917,845.083 832.417,848.083 827.25,850.25C822.083,852.417 816.5,853.5 810.5,853.5C798.833,853.5 788.833,849.333 780.5,841Z"
						fill="currentColor"
					/>
				</svg>
			</TextBoxButton>
		{/if}
		{#if type === "search" && searchButton}
			<TextBoxButton aria-label="Search" on:click={handleSearch}>
				<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="86 86 853 853">
					<path
						d="M938.5,426.5C938.5,473.5 929.583,517.75 911.75,559.25C893.917,600.75 869.5,636.917 838.5,667.75C807.5,698.583 771.333,723 730,741C688.667,759 644.5,768 597.5,768C559.167,768 522.25,761.833 486.75,749.5C451.25,737.167 418.333,719.333 388,696L158,926C149.667,934.333 139.667,938.5 128,938.5C116.333,938.5 106.333,934.333 98,926C89.6667,917.667 85.5,907.667 85.5,896C85.5,884.333 89.6667,874.333 98,866L328,636C304.667,605.667 286.833,572.75 274.5,537.25C262.167,501.75 256,464.833 256,426.5C256,379.5 265,335.333 283,294C301,252.667 325.417,216.5 356.25,185.5C387.083,154.5 423.25,130.083 464.75,112.25C506.25,94.4167 550.5,85.5 597.5,85.5C628.833,85.5 659,89.5834 688,97.75C717,105.917 744.167,117.417 769.5,132.25C794.833,147.083 817.833,164.833 838.5,185.5C859.167,206.167 876.917,229.167 891.75,254.5C906.583,279.833 918.083,307 926.25,336C934.417,365 938.5,395.167 938.5,426.5ZM853.5,426.5L853.5,421.5C853.5,386.833 846.583,354.25 832.75,323.75C818.917,293.25 800.25,266.667 776.75,244C753.25,221.333 726.083,203.417 695.25,190.25C664.417,177.083 631.833,170.5 597.5,170.5C562.167,170.5 528.917,177.167 497.75,190.5C466.583,203.833 439.417,222.083 416.25,245.25C393.083,268.417 374.833,295.583 361.5,326.75C348.167,357.917 341.5,391.167 341.5,426.5C341.5,461.833 348.167,495.083 361.5,526.25C374.833,557.417 393.083,584.583 416.25,607.75C439.417,630.917 466.583,649.167 497.75,662.5C528.917,675.833 562.167,682.5 597.5,682.5C632.833,682.5 666.083,675.833 697.25,662.5C728.417,649.167 755.583,630.917 778.75,607.75C801.917,584.583 820.167,557.417 833.5,526.25C846.833,495.083 853.5,461.833 853.5,426.5Z"
						fill="currentColor"
					/>
				</svg>
            </TextBoxButton>
		{/if}
		{#if type === "password" && value && revealButton}
			<TextBoxButton aria-label="Reveal password" on:mousedown={handleReveal}>
                <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 171 1024 683">
					<path
						d="M0,554.5C0,550.833 0.5,547.167 1.5,543.5C11.5,505.833 25.75,470.417 44.25,437.25C62.75,404.083 84.5833,373.667 109.75,346C134.917,318.333 162.75,293.667 193.25,272C223.75,250.333 256.25,231.917 290.75,216.75C325.25,201.583 361.167,190.083 398.5,182.25C435.833,174.417 473.667,170.5 512,170.5C550,170.5 587.583,174.417 624.75,182.25C661.917,190.083 697.75,201.5 732.25,216.5C766.75,231.5 799.417,249.917 830.25,271.75C861.083,293.583 889.083,318.25 914.25,345.75C939.417,373.25 961.25,403.5 979.75,436.5C998.25,469.5 1012.5,504.833 1022.5,542.5C1023.5,546.167 1024,550 1024,554C1024,566 1019.92,576.083 1011.75,584.25C1003.58,592.417 993.5,596.5 981.5,596.5C971.5,596.5 962.917,593.667 955.75,588C948.583,582.333 943.333,574.833 940,565.5C937,556.167 934.083,547.5 931.25,539.5C928.417,531.5 925.5,523.583 922.5,515.75C919.5,507.917 916.167,500.167 912.5,492.5C908.833,484.833 904.333,476.667 899,468C879.333,435 855.583,405.417 827.75,379.25C799.917,353.083 769.333,330.917 736,312.75C702.667,294.583 667.417,280.583 630.25,270.75C593.083,260.917 555.5,256 517.5,256L506.5,256C468.5,256 430.917,260.917 393.75,270.75C356.583,280.583 321.333,294.667 288,313C254.667,331.333 224,353.583 196,379.75C168,405.917 144.333,435.5 125,468.5C119.667,477.167 115.167,485.417 111.5,493.25C107.833,501.083 104.5,508.833 101.5,516.5C98.5,524.167 95.5833,532 92.75,540C89.9167,548 87,556.667 84,566C80.6667,575.333 75.5,582.917 68.5,588.75C61.5,594.583 52.8333,597.5 42.5,597.5C36.8333,597.5 31.4167,596.333 26.25,594C21.0833,591.667 16.5833,588.583 12.75,584.75C8.91667,580.917 5.83333,576.417 3.5,571.25C1.16667,566.083 0,560.5 0,554.5ZM256,597.5L256,592.5C256,557.833 262.917,525.25 276.75,494.75C290.583,464.25 309.25,437.667 332.75,415C356.25,392.333 383.417,374.417 414.25,361.25C445.083,348.083 477.667,341.5 512,341.5C547.333,341.5 580.583,348.167 611.75,361.5C642.917,374.833 670.083,393.083 693.25,416.25C716.417,439.417 734.667,466.583 748,497.75C761.333,528.917 768,562.167 768,597.5C768,632.833 761.333,666.083 748,697.25C734.667,728.417 716.417,755.583 693.25,778.75C670.083,801.917 642.917,820.167 611.75,833.5C580.583,846.833 547.333,853.5 512,853.5C476.667,853.5 443.417,846.833 412.25,833.5C381.083,820.167 353.917,801.917 330.75,778.75C307.583,755.583 289.333,728.417 276,697.25C262.667,666.083 256,632.833 256,597.5ZM682.5,597.5L682.5,594C682.5,571 677.917,549.333 668.75,529C659.583,508.667 647.167,490.917 631.5,475.75C615.833,460.583 597.667,448.583 577,439.75C556.333,430.917 534.667,426.5 512,426.5C488.333,426.5 466.167,431 445.5,440C424.833,449 406.833,461.25 391.5,476.75C376.167,492.25 364,510.417 355,531.25C346,552.083 341.5,574.167 341.5,597.5C341.5,621.167 346,643.333 355,664C364,684.667 376.167,702.667 391.5,718C406.833,733.333 424.833,745.5 445.5,754.5C466.167,763.5 488.333,768 512,768C535.333,768 557.417,763.5 578.25,754.5C599.083,745.5 617.167,733.333 632.5,718C647.833,702.667 660,684.667 669,664C678,643.333 682.5,621.167 682.5,597.5Z"
						fill="currentColor"
					/>
				</svg>
            </TextBoxButton>
		{/if}
		<slot name="buttons" />
	</div>
</div>

<style lang="scss">
	@use "./TextBox";
</style>